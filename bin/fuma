#!/usr/bin/env python

"""
This file is part of FuMa.

FuMa is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

FuMa is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with FuMa. If not, see <http://www.gnu.org/licenses/>.
"""

import sys,os,os.path,argparse



from ParseBED import ParseBED
from OverlayFusions import OverlayFusions

from Readers import *

from CompareFusionsGTFOverlay import CompareFusionsGTFOverlay



if __name__ == "__main__":
	parser = argparse.ArgumentParser()
	
	parser.add_argument("-a","--add-gene-annotation",help="alias:filename  * file in BED format",nargs="*")
	
	parser.add_argument("-s","--add-sample",help="alias:type:filename",nargs="+",required=True)
	parser.add_argument("-l","--link-sample-to-annotation",help="sample_alias:annotation_alias",nargs="*")
	
	parser.add_argument("-f","--format",default="summary",choices=["summary","extensive"],help="Output-format")
	
	parser.add_argument("-o","--output",help="output filename; '-' for stdout",default="overlap/")
	
	args = parser.parse_args()
	
	gene_annotations = {}
	if(args.add_gene_annotation):
		for gene_annotation in args.add_gene_annotation:
			gene_annotation = gene_annotation.split(":",1)
			gene_annotations[gene_annotation[0]] = ParseBED(gene_annotation[1],gene_annotation[0])
	
	samples = {}
	sample_names = []
	for sample in args.add_sample:
		
		sample = sample.split(":",2)
		
		if(sample[0] in sample_names):
			raise Exception("non-unique sample alias: "+sample[0])
		elif(sample[0].find("~") > -1):
			raise Exception("a sample alias may not include the '~' char: "+sample[0])
		else:
			sample_names.append(sample[0])
			sample[1] = sample[1].lower().replace("-","").replace("_","").replace(" ","")
			
			if(sample[1] in ["cg","completegenomics"]):
				samples[sample[0]] = ReadCGhighConfidenceJunctionsBeta(sample[2],sample[0])
			elif(sample[1] == "chimerascan"):
				samples[sample[0]] = ReadChimeraScan(sample[2],sample[0])
			elif(sample[1] == "defuse"):
				samples[sample[0]] = ReadDefuse(sample[2],sample[0])
			elif(sample[1] in ["illuminahiseq","illuminahiseqvcf"]):
				samples[sample[0]] = ReadIlluminaHiSeqVCF(sample[2],sample[0])
			elif(sample[1] == "tophatfusionpost"):
				samples[sample[0]] = ReadTophatFusionPost(sample[2],sample[0])
			elif(sample[1] == "tophatfusionpre"):
				samples[sample[0]] = ReadTophatFusionPre(sample[2],sample[0])
			elif(sample[1] == "trinitygmap"):
				samples[sample[0]] = ReadTrinityGMAP(sample[2],sample[0])
			else:
				raise Exception("unsupported sample type: "+sample[1])
	
	if(args.link_sample_to_annotation):
		tmp = CompareFusionsGTFOverlay(False,False)
		
		for link in args.link_sample_to_annotation:
			link = link.split(":",1)
			
			if(samples.has_key(link[0])):
				sample = samples[link[0]]
			else:
				raise Exception("unknown sample: "+link[0])
			
			if(gene_annotations.has_key(link[1])):
				gene_annotation = gene_annotations[link[1]]
			else:
				raise Exception("unknown annotation: "+link[1])
			
			sample.overlay_left_locations_to_genes(gene_annotation)		#@todo - use one function for both
			sample.overlay_right_locations_to_genes(gene_annotation)
			
			samples[link[0]] = tmp.remove_duplicates(sample)
	
	o = OverlayFusions()
	
	for sample_name in sample_names:
		o.add_dataset(samples[sample_name])
	
	o.overlay_fusions()
	
	if(args.format == "summary"):
		o.export3(args.output)
	else:
		o.export2(args.output)