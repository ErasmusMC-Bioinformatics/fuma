#!/usr/bin/env python

"""[License: GNU General Public License v3 (GPLv3)]
 
 This file is part of FuMa.
 
 FuMa is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.
 
 FuMa is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with this program. If not, see <http://www.gnu.org/licenses/>.

 Documentation as defined by:
 <http://epydoc.sourceforge.net/manual-fields.html#fields-synonyms>
"""

import sys,os,os.path,argparse



from fuma.ParseBED import ParseBED
from fuma.OverlapComplex import OverlapComplex

from fuma.Readers import *

from fuma.CompareFusionsBySpanningGenes import CompareFusionsBySpanningGenes



if __name__ == "__main__":
	parser = argparse.ArgumentParser()
	
	parser.add_argument("-a","--add-gene-annotation",help="alias:filename  * file in BED format",nargs="*")
	
	parser.add_argument("-s","--add-sample",help="alias:type:filename",nargs="+",required=True)
	parser.add_argument("-l","--link-sample-to-annotation",help="sample_alias:annotation_alias",nargs="*")
	
	parser.add_argument("-f","--format",default="summary",choices=["summary","extensive"],help="Output-format")
	
	parser.add_argument("-o","--output",help="output filename; '-' for stdout",default="overlap/")
	
	args = parser.parse_args()
	
	gene_annotations = {}
	if(args.add_gene_annotation):
		for gene_annotation in args.add_gene_annotation:
			gene_annotation = gene_annotation.split(":",1)
			gene_annotations[gene_annotation[0]] = ParseBED(gene_annotation[1],gene_annotation[0])
	
	samples = {}
	sample_names = []
	for sample in args.add_sample:
		sample_name, input_format, sample_filename = sample.split(":",2)
		
		if(sample_name in sample_names):
			raise Exception("non-unique sample alias: "+sample_name)
		elif(sample_name.find("~") > -1):
			raise Exception("a sample alias may not include the '~' char: "+sample_name)
		else:
			sample_names.append(sample_name)
			input_format = input_format.lower().replace("-","").replace("_","").replace(" ","")
			
			if(input_format in ["cg","completegenomics"]):
				samples[sample_name] = ReadCGhighConfidenceJunctionsBeta(sample_filename,sample_name)
			elif(input_format == "chimerascan"):
				samples[sample_name] = ReadChimeraScanAbsoluteBEDPE(sample_filename,sample_name)
			elif(input_format == "defuse"):
				samples[sample_name] = ReadDefuse(sample_filename,sample_name)
			elif(input_format in ["illuminahiseq","illuminahiseqvcf"]):
				samples[sample_name] = ReadIlluminaHiSeqVCF(sample_filename,sample_name)
			elif(input_format == "tophatfusionpost"):
				samples[sample_name] = ReadTophatFusionPost(sample_filename,sample_name)
			elif(input_format == "tophatfusionpre"):
				samples[sample_name] = ReadTophatFusionPre(sample_filename,sample_name)
			elif(input_format == "trinitygmap"):
				samples[sample_name] = ReadTrinityGMAP(sample_filename,sample_name)
			else:
				raise Exception("unsupported sample type: "+input_format)
	
	if(args.link_sample_to_annotation):
		for link in args.link_sample_to_annotation:
			sample_name, reference_name = link.split(":",1)
			
			if(not samples.has_key(sample_name)):
				raise Exception("unknown sample: "+sample_name)
			
			if(not gene_annotations.has_key(reference_name)):
				raise Exception("unknown annotation: "+reference_name)
			
			samples[sample_name].annotate_genes(gene_annotations[reference_name])
			samples[sample_name].remove_duplicates("by-gene-names")
	
	o = OverlapComplex()
	
	for sample_name in sample_names:
		o.add_experiment(samples[sample_name])
	
	o.overlay_fusions()
	
	if(args.format == "summary"):
		o.export3(args.output)
	else:
		o.export2(args.output)
